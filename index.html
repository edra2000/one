<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مراقبة العملات الرقمية</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1c1c1c;
      color: #f0f8ff;
      margin: 0;
      padding: 20px;
    }
    .loading-message, .error-message {
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 20px;
    }
    .error-message {
      color: #ff4d4d;
    }
    .crypto-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
    }
    .crypto-card {
      background-color: #2c2c2c;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 0 8px #00000050;
      transition: transform 0.3s ease;
    }
    .crypto-card:hover {
      transform: scale(1.03);
    }
    .logo {
      width: 42px;
      height: 42px;
      margin-bottom: 6px;
    }
    .symbol {
      font-size: 1.1em;
      font-weight: bold;
    }
    .price {
      font-size: 1em;
      margin: 6px 0;
    }
    .change {
      font-weight: bold;
      margin: 6px 0;
    }
    .positive {
      color: #00ff88;
    }
    .negative {
      color: #ff3c3c;
    }
    .volume {
      font-size: 0.9em;
      margin-top: 6px;
    }
    .liquidity-bar {
      height: 12px;
      border-radius: 6px;
      background: #444;
      overflow: hidden;
      margin-top: 10px;
    }
    .liquidity-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.6s ease;
    }
  </style>
</head>
<body>

<div class="loading-message">جارٍ تحميل البيانات...</div>
<div class="error-message" style="display:none;"></div>
<div class="crypto-grid" style="display:none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const apiUrl = 'http://localhost:3000/api/binance';
  const gridContainer = document.querySelector('.crypto-grid');
  const loadingMessage = document.querySelector('.loading-message');
  const errorMessage = document.querySelector('.error-message');

  function displayError(message) {
    loadingMessage.style.display = 'none';
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
  }

  function getColor(percent) {
    if (percent >= 75) return '#00ff88';
    if (percent >= 50) return '#ffaa00';
    if (percent >= 25) return '#ff8800';
    return '#ff4444';
  }

  function fetchAndDisplayData() {
    fetch(apiUrl)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        loadingMessage.style.display = 'none';
        errorMessage.style.display = 'none';
        gridContainer.style.display = 'grid';
        gridContainer.style.opacity = '0.7'; // تقليل الوميض
        gridContainer.innerHTML = '';

        const filtered = data
          .filter(ticker =>
            ticker.symbol.endsWith('USDT') &&
            !ticker.symbol.startsWith('USD') &&
            parseFloat(ticker.quoteVolume) > 0
          )
          .sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
          .slice(0, 30);

        filtered.forEach(ticker => {
          const symbol = ticker.symbol.replace('USDT', '');
          const symbolLower = symbol.toLowerCase();
          const price = parseFloat(ticker.lastPrice);
          const change = parseFloat(ticker.priceChangePercent);
          const volume = parseFloat(ticker.quoteVolume);
          const liquidityPercent = Math.min(100, Math.floor((volume / 100000000) * 100));

          const card = document.createElement('div');
          card.className = 'crypto-card';
          card.innerHTML = `
            <img class="logo" src="https://coinicons-api.vercel.app/api/icon/${symbolLower}" onerror="this.src='https://via.placeholder.com/42'" />
            <div class="symbol">${symbol}</div>
            <div class="price">${price.toFixed(2)} USD</div>
            <div class="change ${change >= 0 ? 'positive' : 'negative'}">
              ${change.toFixed(2)}%
            </div>
            <div class="liquidity-bar">
              <div class="liquidity-fill" style="width: ${liquidityPercent}%; background: ${getColor(liquidityPercent)};"></div>
            </div>
            <div class="volume">الحجم: ${volume.toLocaleString()}</div>
          `;
          gridContainer.appendChild(card);
        });
      })
      .catch(error => {
        console.error('خطأ:', error);
        displayError("حدث خطأ أثناء جلب البيانات من الخادم.");
      });
  }

  fetchAndDisplayData();
  setInterval(fetchAndDisplayData, 10000);
});
</script>

</body>
</html>
